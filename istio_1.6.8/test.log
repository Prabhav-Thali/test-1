Building with your local toolchain.
export PATH=/usr/lib/llvm-9/bin:/root/jdk-11.0.3+7/bin:/root/golang/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/llvm-9/bin/:/root/bazel/output/ CC=/usr/bin/gcc CXX=/usr/bin/g++ && bazel  test --local_ram_resources=12288 --local_cpu_resources=8 --verbose_failures --test_env=ENVOY_IP_TEST_VERSIONS=v4only --test_output=errors  -- //... -tools/deb/... 
Loading: 
Loading: 0 packages loaded
Analyzing: 199 targets (0 packages loaded, 0 targets configured)
WARNING: /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/external/remote_java_tools_linux/BUILD:671:1: in hdrs attribute of cc_library rule @remote_java_tools_linux//:combiners: Artifact 'external/remote_java_tools_linux/java_tools/src/tools/singlejar/zip_headers.h' is duplicated (through '@remote_java_tools_linux//:transient_bytes' and '@remote_java_tools_linux//:zip_headers'). Since this rule was created by the macro 'cc_library', the error might have been caused by the macro implementation
INFO: Analyzed 199 targets (0 packages loaded, 0 targets configured).
INFO: Found 152 targets and 47 test targets...
[89 / 3,027] [Prepa] BazelWorkspaceStatusAction stable-status.txt
[6,588 / 6,625] 6 / 47 tests; checking cached actions
INFO: Elapsed time: 3.113s, Critical Path: 0.20s
INFO: 0 processes.
INFO: Build completed successfully, 2 total actions
//extensions/common:proto_util_test                             (cached) PASSED in 5.0s
//extensions/common:util_test                                   (cached) PASSED in 4.6s
//extensions/stackdriver/edges:edge_reporter_test               (cached) PASSED in 10.7s
//extensions/stackdriver/log:logger_test                        (cached) PASSED in 5.5s
//extensions/stackdriver/metric:registry_test                   (cached) PASSED in 5.5s
//extensions/stats:plugin_test                                  (cached) PASSED in 5.1s
//src/envoy/http/alpn:alpn_test                                 (cached) PASSED in 10.8s
//src/envoy/http/alpn:config_test                               (cached) PASSED in 8.4s
//src/envoy/http/authn:authenticator_base_test                  (cached) PASSED in 11.6s
//src/envoy/http/authn:authn_utils_test                         (cached) PASSED in 7.7s
//src/envoy/http/authn:filter_context_test                      (cached) PASSED in 7.3s
//src/envoy/http/authn:http_filter_integration_test             (cached) PASSED in 92.0s
//src/envoy/http/authn:http_filter_test                         (cached) PASSED in 9.2s
//src/envoy/http/authn:origin_authenticator_test                (cached) PASSED in 8.3s
//src/envoy/http/authn:peer_authenticator_test                  (cached) PASSED in 7.6s
//src/envoy/http/jwt_auth:http_filter_integration_test          (cached) PASSED in 83.1s
//src/envoy/http/jwt_auth:jwt_authenticator_test                (cached) PASSED in 17.9s
//src/envoy/http/jwt_auth:jwt_test                              (cached) PASSED in 7.8s
//src/envoy/http/jwt_auth:token_extractor_test                  (cached) PASSED in 8.0s
//src/envoy/tcp/forward_downstream_sni:forward_downstream_sni_test (cached) PASSED in 8.2s
//src/envoy/tcp/metadata_exchange:metadataexchange_test         (cached) PASSED in 8.9s
//src/envoy/tcp/sni_verifier:sni_verifier_test                  (cached) PASSED in 9.7s
//src/envoy/tcp/tcp_cluster_rewrite:config_test                 (cached) PASSED in 8.5s
//src/envoy/tcp/tcp_cluster_rewrite:tcp_cluster_rewrite_test    (cached) PASSED in 7.9s
//src/envoy/utils:authn_test                                    (cached) PASSED in 7.3s
//src/envoy/utils:mixer_control_test                            (cached) PASSED in 8.0s
//src/envoy/utils:utils_test                                    (cached) PASSED in 10.7s
//src/istio/control/http:attributes_builder_test                (cached) PASSED in 0.6s
//src/istio/control/http:request_handler_impl_test              (cached) PASSED in 0.3s
//src/istio/control/tcp:attributes_builder_test                 (cached) PASSED in 0.2s
//src/istio/control/tcp:request_handler_impl_test               (cached) PASSED in 0.4s
//src/istio/mixerclient:attribute_compressor_test               (cached) PASSED in 0.3s
//src/istio/mixerclient:check_cache_test                        (cached) PASSED in 0.3s
//src/istio/mixerclient:client_impl_test                        (cached) PASSED in 0.3s
//src/istio/mixerclient:quota_cache_test                        (cached) PASSED in 0.2s
//src/istio/mixerclient:referenced_test                         (cached) PASSED in 0.5s
//src/istio/mixerclient:report_batch_test                       (cached) PASSED in 0.3s
//src/istio/prefetch:circular_queue_test                        (cached) PASSED in 0.7s
//src/istio/prefetch:quota_prefetch_test                        (cached) PASSED in 0.6s
//src/istio/prefetch:time_based_counter_test                    (cached) PASSED in 0.1s
//src/istio/quota_config:config_parser_impl_test                (cached) PASSED in 0.8s
//src/istio/utils:logger_test                                   (cached) PASSED in 0.2s
//src/istio/utils:simple_lru_cache_test                         (cached) PASSED in 4.8s
//src/istio/utils:utils_test                                    (cached) PASSED in 0.3s
//test/integration:exchanged_token_integration_test             (cached) PASSED in 145.3s
//test/integration:istio_http_integration_test                  (cached) PASSED in 171.2s
//test/integration:istio_http_integration_test_with_envoy_jwt_filter (cached) PASSED in 202.9s

Executed 0 out of 47 tests: 47 tests pass.
There were tests whose specified size is too big. Use the --test_verbose_timeout_warnings command line option to see which ones these are.
INFO: Build completed successfully, 2 total actions
env ENVOY_PATH=/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy GO111MODULE=on go test ./...
?   	istio.io/proxy/src/envoy/http/jwt_auth/sample	[no test files]
?   	istio.io/proxy/test/backend/echo	[no test files]
?   	istio.io/proxy/test/envoye2e	[no test files]
2020/08/17 14:34:05 XDS server starting on 20085
2020/08/17 14:34:05 update config for "client" with version "0"
name: outbound|9080|tcp|server.default.svc.cluster.local
connect_timeout: 1s
type: STATIC
load_assignment:
  cluster_name: outbound|9080|tcp|server.default.svc.cluster.local
  endpoints:
  - lb_endpoints:
    - endpoint:
        address:
          socket_address:
            address: 127.0.0.1
            port_value: 20083

filters:


name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20082
listener_filters:
- name: "envoy.filters.listener.tls_inspector"
- name: "envoy.filters.listener.http_inspector"
filter_chains:
- filters:
  - name: tcp_proxy
    typed_config:
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
      value:
        stat_prefix: outbound_tcp
        cluster: outbound|9080|tcp|server.default.svc.cluster.local
2020/08/17 14:34:05 update config for "server" with version "0"
name: inbound|9080|tcp|server.default.svc.cluster.local
connect_timeout: 1s
type: STATIC
load_assignment:
  cluster_name: inbound|9080|tcp|server.default.svc.cluster.local
  endpoints:
  - lb_endpoints:
    - endpoint:
        address:
          socket_address:
            address: 127.0.0.1
            port_value: 20080

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20083
listener_filters:
- name: "envoy.filters.listener.tls_inspector"
- name: "envoy.filters.listener.http_inspector"
filter_chains:
- filters:
  - name: tcp_proxy
    typed_config:
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
      value:
        stat_prefix: inbound_tcp
        cluster: inbound|9080|tcp|server.default.svc.cluster.local
  
2020/08/17 14:34:05 envoy bootstrap:
node:
  id: client
  cluster: test-cluster
  metadata: {  }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20081

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20085
    http2_protocol_options: {}
    name: xds_cluster
  - name: outbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    http2_protocol_options: {}
    load_assignment:
      cluster_name: outbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20083
    
  

2020/08/17 14:34:05 admin port 20081
2020/08/17 14:34:06 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-421932301.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:06 stopping XDS server
--- FAIL: TestBasicTCPFlow (1.79s)
    basic_xds_test.go:122: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
2020/08/17 14:34:06 XDS server starting on 20025
2020/08/17 14:34:06 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20022
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client
      http_filters:
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:06 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20023
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server
      http_filters:
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:06 envoy bootstrap:
node:
  id: client
  cluster: test-cluster
  metadata: {  }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20021

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20025
    http2_protocol_options: {}
    name: xds_cluster
  - name: outbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    http2_protocol_options: {}
    load_assignment:
      cluster_name: outbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20023
    
  

2020/08/17 14:34:06 admin port 20021
2020/08/17 14:34:06 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-199018248.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:06 stopping XDS server
--- FAIL: TestBasicHTTP (0.11s)
    basic_xds_test.go:139: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
2020/08/17 14:34:06 XDS server starting on 20045
2020/08/17 14:34:06 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20042
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client
      http_filters:
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:06 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20043
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server
      http_filters:
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  transport_socket:
    name: tls
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
      common_tls_context:
        tls_certificates:
        - certificate_chain: { filename: "testdata/certs/server.cert" }
          private_key: { filename: "testdata/certs/server-key.cert" }
        validation_context:
          trusted_ca: { filename: "testdata/certs/root.cert" }
      require_client_certificate: true
  

2020/08/17 14:34:06 envoy bootstrap:
node:
  id: client
  cluster: test-cluster
  metadata: {  }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20041

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20045
    http2_protocol_options: {}
    name: xds_cluster
  - name: outbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    http2_protocol_options: {}
    load_assignment:
      cluster_name: outbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20043
    transport_socket:
      name: tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        common_tls_context:
          tls_certificates:
          - certificate_chain: { filename: "testdata/certs/client.cert" }
            private_key: { filename: "testdata/certs/client-key.cert" }
          validation_context:
            trusted_ca: { filename: "testdata/certs/root.cert" }
        sni: server.com
    
  

2020/08/17 14:34:06 admin port 20041
2020/08/17 14:34:06 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-078651079.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:06 stopping XDS server
--- FAIL: TestBasicHTTPwithTLS (0.24s)
    basic_xds_test.go:158: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
2020/08/17 14:34:06 XDS server starting on 20065
2020/08/17 14:34:06 update config for "server" with version "0"
name: outbound|9080|http|server.default.svc.cluster.local
connect_timeout: 1s
type: STATIC
load_assignment:
  cluster_name: outbound|9080|http|server.default.svc.cluster.local
  endpoints:
  - lb_endpoints:
    - endpoint:
        address:
          socket_address:
            address: 127.0.0.1
            port_value: 20063


name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20062
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client
      http_filters:
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s


name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20063
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server
      http_filters:
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:06 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: {  }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20064

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20065
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20060
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20060
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:06 admin port 20064
2020/08/17 14:34:06 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-551095162.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:06 stopping XDS server
--- FAIL: TestBasicHTTPGateway (0.17s)
    basic_xds_test.go:177: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
FAIL
FAIL	istio.io/proxy/test/envoye2e/basic_flow	2.343s
?   	istio.io/proxy/test/envoye2e/driver	[no test files]
?   	istio.io/proxy/test/envoye2e/env	[no test files]
?   	istio.io/proxy/test/envoye2e/env/grpc_echo	[no test files]
{"APP_CONTAINERS": "test,bonzai",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "productpage",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "productpage-v1",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "productpage-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "productpage-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-productpage",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20106",
"STACKDRIVER_ROOT_CA_FILE": "",
"STACKDRIVER_TOKEN_FILE": "",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"STS_PORT": "20107",
"WORKLOAD_NAME": "productpage-v1",
"app": "productpage",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container productpage",
"pod-template-hash": "84975bc778",
"version": "v1"
}
2020/08/17 14:34:04 XDS server starting on 20105
2020/08/17 14:34:04 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20103
filter_chains:
- filters:
  - name: envoy.http_connection_manager
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local:
                    inline_string: envoy.wasm.metadata_exchange
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:04 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20106",
"STACKDRIVER_ROOT_CA_FILE": "",
"STACKDRIVER_TOKEN_FILE": "",
"STS_PORT": "20107",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20104

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20105
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20100
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20100
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:04 admin port 20104
2020/08/17 14:34:04 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-388620617.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:04 stopping XDS server
--- FAIL: TestHTTPExchange (0.18s)
    exchange_xds_test.go:126: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
FAIL
FAIL	istio.io/proxy/test/envoye2e/http_metadata_exchange	0.294s
metric:
  labels:
    destination_canonical_revision: version-1
    destination_canonical_service_name: ratings
    destination_canonical_service_namespace: default
    destination_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1
    destination_port: '20183'
    destination_principal: unknown
    destination_service_name: server
    destination_service_namespace: default
    destination_workload_name: ratings-v1
    destination_workload_namespace: default
    mesh_uid: mesh
    request_operation: GET
    request_protocol: http
    response_code: "200"
    service_authentication_policy: unknown # TODO: upstream TLS indicator is not reported
    source_canonical_revision: version-1
    source_canonical_service_name: productpage-v1
    source_canonical_service_namespace: default
    source_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1
    source_principal: unknown
    source_workload_name: productpage-v1
    source_workload_namespace: default
  type: istio.io/service/client/request_count
points:
- value:
    int64Value: "10"
resource:
  labels:
    cluster_name: test-cluster
    location: us-east4-b
    namespace_name: default
    pod_name: productpage-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_pod

metric:
  labels:
    destination_canonical_revision: version-1
    destination_canonical_service_name: ratings
    destination_canonical_service_namespace: default
    destination_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1
    destination_port: '20183'
    destination_principal: unknown
    destination_service_name: server
    destination_service_namespace: default
    destination_workload_name: ratings-v1
    destination_workload_namespace: default
    mesh_uid: mesh
    request_operation: GET
    request_protocol: http
    response_code: "200"
    service_authentication_policy: NONE
    source_canonical_revision: version-1
    source_canonical_service_name: productpage-v1
    source_canonical_service_namespace: default
    source_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1
    source_principal: unknown
    source_workload_name: productpage-v1
    source_workload_namespace: default
  type: istio.io/service/server/request_count
points:
- value:
    int64Value: "10"
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

labels:
  destination_name: ratings-v1-84975bc778-pxz2w
  destination_namespace: default
  destination_workload: ratings-v1
  destination_app: ratings
  destination_canonical_service: ratings
  destination_canonical_revision: version-1
  destination_version: v1
  mesh_uid: mesh
logName: projects/test-project/logs/server-accesslog-stackdriver
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

http_request:
  request_method: "GET"
  request_url: "http://127.0.0.1:20182/"
  server_ip: "127.0.0.1:20183"
  protocol: "http"
  status: 200
labels:
  destination_principal: ""
  destination_service_host: server.default.svc.cluster.local
  response_flag: "-"
  service_authentication_policy: NONE
  source_name: productpage-v1-84975bc778-pxz2w
  source_namespace: default
  source_principal: ""
  source_workload: productpage-v1
  source_app: productpage
  source_canonical_service: productpage-v1
  source_canonical_revision: version-1
  source_version: v1
severity: INFO
parent: projects/test-project
mesh_uid: mesh
traffic_assertions:
- protocol: PROTOCOL_HTTP
  destination_service_name: server
  destination_service_namespace: default
  source:
    uid: kubernetes://productpage-v1-84975bc778-pxz2w.default
    location: us-east4-b
    cluster_name: test-cluster
    owner_uid: kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1
    workload_name: productpage-v1
    workload_namespace: default
    canonical_service: productpage-v1
    canonical_revision: version-1
  destination:
    uid: kubernetes://ratings-v1-84975bc778-pxz2w.default
    location: us-east4-b
    cluster_name: test-cluster
    owner_uid: kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1
    workload_name: ratings-v1
    workload_namespace: default
    canonical_service: ratings
    canonical_revision: version-1


2020/08/17 14:34:06 XDS server starting on 20185
2020/08/17 14:34:06 Stackdriver server listening on port 20186
2020/08/17 14:34:06 Pinging URL:  http://localhost:20187/health
2020/08/17 14:34:06 HTTP GET http://localhost:20187/health
2020/08/17 14:34:06 Get "http://localhost:20187/health": dial tcp 127.0.0.1:20187: connect: connection refused
2020/08/17 14:34:06 Will wait 200ms and try again.
2020/08/17 14:34:07 Pinging URL:  http://localhost:20187/health
2020/08/17 14:34:07 HTTP GET http://localhost:20187/health
2020/08/17 14:34:07 Server is up and running...
2020/08/17 14:34:07 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20182
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_outbound"
              vm_config:
                vm_id: "stackdriver_outbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:07 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20183
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_inbound"
              vm_config:
                vm_id: "stackdriver_inbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {"enableMeshEdgesReporting": "true", "meshEdgesReportingDuration": "1s"}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:07 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20186",
"STACKDRIVER_ROOT_CA_FILE": "/root/proxy/testdata/certs/stackdriver.pem",
"STACKDRIVER_TOKEN_FILE": "/root/proxy/testdata/certs/access-token",
"STS_PORT": "20187",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20184
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20185
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20180
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20180
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:07 admin port 20184
2020/08/17 14:34:07 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-780146195.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:07 stopping XDS server
--- FAIL: TestStackdriverPayload (2.78s)
    stackdriver_xds_test.go:253: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
labels:
  destination_name: ratings-v1-84975bc778-pxz2w
  destination_namespace: default
  destination_workload: ratings-v1
  destination_app: ratings
  destination_version: v1
  destination_canonical_revision: version-1
  destination_canonical_service: ratings
  mesh_uid: mesh
logName: projects/test-project/logs/server-accesslog-stackdriver
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

http_request:
  request_method: "GET"
  request_url: "http://127.0.0.1:20202/"
  server_ip: "127.0.0.1:20203"
  protocol: "http"
  status: 200
labels:
  destination_principal: ""
  destination_service_host: server.default.svc.cluster.local
  response_flag: "-"
  service_authentication_policy: NONE
  source_name: ratings-v1-84975bc778-pxz2w
  source_namespace: default
  source_principal: ""
  source_workload: ratings-v1
  source_app: ratings
  source_version: v1
  source_canonical_service: ratings
  source_canonical_revision: version-1
severity: INFO
2020/08/17 14:34:07 XDS server starting on 20205
2020/08/17 14:34:07 Stackdriver server listening on port 20206
2020/08/17 14:34:07 Pinging URL:  http://localhost:20207/health
2020/08/17 14:34:07 HTTP GET http://localhost:20207/health
2020/08/17 14:34:07 Server is up and running...
2020/08/17 14:34:07 update config for "server" with version "0"
name: outbound|9080|http|server.default.svc.cluster.local
connect_timeout: 1s
type: STATIC
load_assignment:
  cluster_name: outbound|9080|http|server.default.svc.cluster.local
  endpoints:
  - lb_endpoints:
    - endpoint:
        address:
          socket_address:
            address: 127.0.0.1
            port_value: 20203


name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20202
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_outbound"
              vm_config:
                vm_id: "stackdriver_outbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s


name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20203
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_inbound"
              vm_config:
                vm_id: "stackdriver_inbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {"enableMeshEdgesReporting": "true", "meshEdgesReportingDuration": "1s"}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:07 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20206",
"STACKDRIVER_ROOT_CA_FILE": "/root/proxy/testdata/certs/stackdriver.pem",
"STACKDRIVER_TOKEN_FILE": "/root/proxy/testdata/certs/access-token",
"STS_PORT": "20207",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20204
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20205
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20200
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20200
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:07 admin port 20204
2020/08/17 14:34:07 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-921626198.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:07 stopping XDS server
--- FAIL: TestStackdriverPayloadGateway (0.30s)
    stackdriver_xds_test.go:296: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
metric:
  labels:
    destination_canonical_revision: version-1
    destination_canonical_service_name: ratings
    destination_canonical_service_namespace: default
    destination_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1
    destination_port: '20223'
    destination_principal: "spiffe://cluster.local/ns/default/sa/server"
    destination_service_name: server
    destination_service_namespace: default
    destination_workload_name: ratings-v1
    destination_workload_namespace: default
    mesh_uid: mesh
    request_operation: GET
    request_protocol: http
    response_code: "200"
    service_authentication_policy: unknown # TODO: upstream TLS indicator is not reported
    source_canonical_revision: version-1
    source_canonical_service_name: productpage-v1
    source_canonical_service_namespace: default
    source_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1
    source_principal: "spiffe://cluster.local/ns/default/sa/client"
    source_workload_name: productpage-v1
    source_workload_namespace: default
  type: istio.io/service/client/request_count
points:
- value:
    int64Value: "10"
resource:
  labels:
    cluster_name: test-cluster
    location: us-east4-b
    namespace_name: default
    pod_name: productpage-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_pod

metric:
  labels:
    destination_canonical_revision: version-1
    destination_canonical_service_name: ratings
    destination_canonical_service_namespace: default
    destination_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1
    destination_port: '20223'
    destination_principal: "spiffe://cluster.local/ns/default/sa/server"
    destination_service_name: server
    destination_service_namespace: default
    destination_workload_name: ratings-v1
    destination_workload_namespace: default
    mesh_uid: mesh
    request_operation: GET
    request_protocol: http
    response_code: "200"
    service_authentication_policy: MUTUAL_TLS
    source_canonical_revision: version-1
    source_canonical_service_name: productpage-v1
    source_canonical_service_namespace: default
    source_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1
    source_principal: "spiffe://cluster.local/ns/default/sa/client"
    source_workload_name: productpage-v1
    source_workload_namespace: default
  type: istio.io/service/server/request_count
points:
- value:
    int64Value: "10"
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

labels:
  destination_name: ratings-v1-84975bc778-pxz2w
  destination_namespace: default
  destination_workload: ratings-v1
  destination_app: ratings
  destination_canonical_service: ratings
  destination_canonical_revision: version-1
  destination_version: v1
  mesh_uid: mesh
logName: projects/test-project/logs/server-accesslog-stackdriver
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

http_request:
  request_method: "GET"
  request_url: "http://127.0.0.1:20222/"
  server_ip: "127.0.0.1:20223"
  protocol: "http"
  status: 200
labels:
  destination_principal: "spiffe://cluster.local/ns/default/sa/server"
  destination_service_host: server.default.svc.cluster.local
  response_flag: "-"
  service_authentication_policy: MUTUAL_TLS
  source_name: productpage-v1-84975bc778-pxz2w
  source_namespace: default
  source_principal: "spiffe://cluster.local/ns/default/sa/client"
  source_workload: productpage-v1
  source_app: productpage
  source_canonical_service: productpage-v1
  source_canonical_revision: version-1
  source_version: v1
severity: INFO
2020/08/17 14:34:07 XDS server starting on 20225
2020/08/17 14:34:07 Stackdriver server listening on port 20226
2020/08/17 14:34:07 Pinging URL:  http://localhost:20227/health
2020/08/17 14:34:07 HTTP GET http://localhost:20227/health
2020/08/17 14:34:07 Server is up and running...
2020/08/17 14:34:07 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20222
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_outbound"
              vm_config:
                vm_id: "stackdriver_outbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:07 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20223
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_inbound"
              vm_config:
                vm_id: "stackdriver_inbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {"enableMeshEdgesReporting": "true", "meshEdgesReportingDuration": "1s"}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  transport_socket:
    name: tls
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
      common_tls_context:
        tls_certificates:
        - certificate_chain: { filename: "testdata/certs/server.cert" }
          private_key: { filename: "testdata/certs/server-key.cert" }
        validation_context:
          trusted_ca: { filename: "testdata/certs/root.cert" }
      require_client_certificate: true
  

2020/08/17 14:34:07 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20226",
"STACKDRIVER_ROOT_CA_FILE": "/root/proxy/testdata/certs/stackdriver.pem",
"STACKDRIVER_TOKEN_FILE": "/root/proxy/testdata/certs/access-token",
"STS_PORT": "20227",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20224
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20225
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20220
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20220
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:07 admin port 20224
2020/08/17 14:34:07 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-032279485.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:07 stopping XDS server
--- FAIL: TestStackdriverPayloadWithTLS (0.46s)
    stackdriver_xds_test.go:344: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
metric:
  labels:
    destination_canonical_revision: version-1
    destination_canonical_service_name: ratings
    destination_canonical_service_namespace: default
    destination_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1
    destination_port: '20243'
    destination_principal: unknown
    destination_service_name: server
    destination_service_namespace: default
    destination_workload_name: ratings-v1
    destination_workload_namespace: default
    mesh_uid: mesh
    request_operation: GET
    request_protocol: http
    response_code: "200"
    service_authentication_policy: unknown # TODO: upstream TLS indicator is not reported
    source_canonical_revision: version-1
    source_canonical_service_name: productpage-v1
    source_canonical_service_namespace: default
    source_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1
    source_principal: unknown
    source_workload_name: productpage-v1
    source_workload_namespace: default
  type: istio.io/service/client/request_count
points:
- value:
    int64Value: "10"
resource:
  labels:
    cluster_name: test-cluster
    location: us-east4-b
    namespace_name: default
    pod_name: productpage-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_pod

metric:
  labels:
    destination_canonical_revision: version-1
    destination_canonical_service_name: ratings
    destination_canonical_service_namespace: default
    destination_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1
    destination_port: '20243'
    destination_principal: unknown
    destination_service_name: server
    destination_service_namespace: default
    destination_workload_name: ratings-v1
    destination_workload_namespace: default
    mesh_uid: mesh
    request_operation: GET
    request_protocol: http
    response_code: "200"
    service_authentication_policy: NONE
    source_canonical_revision: version-1
    source_canonical_service_name: productpage-v1
    source_canonical_service_namespace: default
    source_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1
    source_principal: unknown
    source_workload_name: productpage-v1
    source_workload_namespace: default
  type: istio.io/service/server/request_count
points:
- value:
    int64Value: "10"
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

labels:
  destination_name: ratings-v1-84975bc778-pxz2w
  destination_namespace: default
  destination_workload: ratings-v1
  destination_app: ratings
  destination_canonical_service: ratings
  destination_canonical_revision: version-1
  destination_version: v1
  mesh_uid: mesh
logName: projects/test-project/logs/server-accesslog-stackdriver
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

http_request:
  request_method: "GET"
  request_url: "http://127.0.0.1:20242/"
  server_ip: "127.0.0.1:20243"
  protocol: "http"
  status: 200
labels:
  destination_principal: ""
  destination_service_host: server.default.svc.cluster.local
  response_flag: "-"
  service_authentication_policy: NONE
  source_name: productpage-v1-84975bc778-pxz2w
  source_namespace: default
  source_principal: ""
  source_workload: productpage-v1
  source_app: productpage
  source_canonical_service: productpage-v1
  source_canonical_revision: version-1
  source_version: v1
severity: INFO
2020/08/17 14:34:08 XDS server starting on 20245
2020/08/17 14:34:08 Stackdriver server listening on port 20246
2020/08/17 14:34:09 Pinging URL:  http://localhost:20247/health
2020/08/17 14:34:09 HTTP GET http://localhost:20247/health
2020/08/17 14:34:09 Server is up and running...
2020/08/17 14:34:09 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20242
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_outbound"
              vm_config:
                vm_id: "stackdriver_outbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:09 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20243
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_inbound"
              vm_config:
                vm_id: "stackdriver_inbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {"enableMeshEdgesReporting": "true", "meshEdgesReportingDuration": "1s"}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:09 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20246",
"STACKDRIVER_ROOT_CA_FILE": "/root/proxy/testdata/certs/stackdriver.pem",
"STACKDRIVER_TOKEN_FILE": "/root/proxy/testdata/certs/access-token",
"STS_PORT": "20247",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20244

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20245
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20240
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20240
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:09 admin port 20244
2020/08/17 14:34:09 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-191335416.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:09 stopping XDS server
--- FAIL: TestStackdriverReload (2.01s)
    stackdriver_xds_test.go:389: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
metric:
  labels:
    destination_canonical_revision: version-1
    destination_canonical_service_name: ratings
    destination_canonical_service_namespace: default
    destination_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1
    destination_port: '20263'
    destination_principal: unknown
    destination_service_name: server
    destination_service_namespace: default
    destination_workload_name: ratings-v1
    destination_workload_namespace: default
    mesh_uid: mesh
    request_operation: GET
    request_protocol: http
    response_code: "200"
    service_authentication_policy: unknown # TODO: upstream TLS indicator is not reported
    source_canonical_revision: version-1
    source_canonical_service_name: productpage-v1
    source_canonical_service_namespace: default
    source_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1
    source_principal: unknown
    source_workload_name: productpage-v1
    source_workload_namespace: default
  type: istio.io/service/client/request_count
points:
- value:
    int64Value: "10"
resource:
  labels:
    cluster_name: test-cluster
    location: us-east4-b
    namespace_name: default
    pod_name: productpage-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_pod

metric:
  labels:
    destination_canonical_revision: version-1
    destination_canonical_service_name: ratings
    destination_canonical_service_namespace: default
    destination_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1
    destination_port: '20263'
    destination_principal: unknown
    destination_service_name: server
    destination_service_namespace: default
    destination_workload_name: ratings-v1
    destination_workload_namespace: default
    mesh_uid: mesh
    request_operation: GET
    request_protocol: http
    response_code: "200"
    service_authentication_policy: NONE
    source_canonical_revision: version-1
    source_canonical_service_name: productpage-v1
    source_canonical_service_namespace: default
    source_owner: kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1
    source_principal: unknown
    source_workload_name: productpage-v1
    source_workload_namespace: default
  type: istio.io/service/server/request_count
points:
- value:
    int64Value: "10"
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

labels:
  destination_name: ratings-v1-84975bc778-pxz2w
  destination_namespace: default
  destination_workload: ratings-v1
  destination_app: ratings
  destination_canonical_service: ratings
  destination_canonical_revision: version-1
  destination_version: v1
  mesh_uid: mesh
logName: projects/test-project/logs/server-accesslog-stackdriver
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

http_request:
  request_method: "GET"
  request_url: "http://127.0.0.1:20262/"
  server_ip: "127.0.0.1:20263"
  protocol: "http"
  status: 200
labels:
  destination_principal: ""
  destination_service_host: server.default.svc.cluster.local
  response_flag: "-"
  service_authentication_policy: NONE
  source_name: productpage-v1-84975bc778-pxz2w
  source_namespace: default
  source_principal: ""
  source_workload: productpage-v1
  source_app: productpage
  source_canonical_service: productpage-v1
  source_canonical_revision: version-1
  source_version: v1
severity: INFO
2020/08/17 14:34:10 XDS server starting on 20265
2020/08/17 14:34:10 Stackdriver server listening on port 20266
2020/08/17 14:34:10 Pinging URL:  http://localhost:20267/health
2020/08/17 14:34:10 HTTP GET http://localhost:20267/health
2020/08/17 14:34:10 Server is up and running...
2020/08/17 14:34:10 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20262
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_outbound"
              vm_config:
                vm_id: "stackdriver_outbound_0"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:10 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20263
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_inbound"
              vm_config:
                vm_id: "stackdriver_inbound_0"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {"enableMeshEdgesReporting": "true", "meshEdgesReportingDuration": "1s"}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:10 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20266",
"STACKDRIVER_ROOT_CA_FILE": "/root/proxy/testdata/certs/stackdriver.pem",
"STACKDRIVER_TOKEN_FILE": "/root/proxy/testdata/certs/access-token",
"STS_PORT": "20267",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20264

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20265
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20260
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20260
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:10 admin port 20264
2020/08/17 14:34:10 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-556322551.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:10 stopping XDS server
--- FAIL: TestStackdriverVMReload (0.45s)
    stackdriver_xds_test.go:433: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
metric:
  labels:
    destination_canonical_revision: version-1
    destination_canonical_service_name: ratings
    destination_canonical_service_namespace: default
    destination_owner: //compute.googleapis.com/projects/23412341234/instanceGroupManagers/324234
    destination_port: '20003'
    destination_principal: unknown
    destination_service_name: server
    destination_service_namespace: default
    destination_workload_name: ratings-v1
    destination_workload_namespace: default
    mesh_uid: mesh
    request_operation: GET
    request_protocol: http
    response_code: "200"
    service_authentication_policy: unknown # TODO: upstream TLS indicator is not reported
    source_canonical_revision: version-1
    source_canonical_service_name: productpage-v1
    source_canonical_service_namespace: default
    source_owner: //compute.googleapis.com/projects/test-project/zones/us-east4-b/instances/productpage-vm
    source_principal: unknown
    source_workload_name: productpage-v1
    source_workload_namespace: default
  type: istio.io/service/client/request_count
points:
- value:
    int64Value: "10"
resource:
  labels:
    zone: us-east4-b
    project_id: test-project
    instance_id: "234215124341324123"
  type: gce_instance

metric:
  labels:
    destination_canonical_revision: version-1
    destination_canonical_service_name: ratings
    destination_canonical_service_namespace: default
    destination_owner: //compute.googleapis.com/projects/23412341234/instanceGroupManagers/324234
    destination_port: '20003'
    destination_principal: unknown
    destination_service_name: server
    destination_service_namespace: default
    destination_workload_name: ratings-v1
    destination_workload_namespace: default
    mesh_uid: mesh
    request_operation: GET
    request_protocol: http
    response_code: "200"
    service_authentication_policy: NONE
    source_canonical_revision: version-1
    source_canonical_service_name: productpage-v1
    source_canonical_service_namespace: default
    source_owner: //compute.googleapis.com/projects/test-project/zones/us-east4-b/instances/productpage-vm
    source_principal: unknown
    source_workload_name: productpage-v1
    source_workload_namespace: default
  type: istio.io/service/server/request_count
points:
- value:
    int64Value: "10"
resource:
  labels:
    zone: us-east4-b
    project_id: test-project
    instance_id: "2342123412341234"
  type: gce_instance

parent: projects/test-project
mesh_uid: mesh
traffic_assertions:
- protocol: PROTOCOL_HTTP
  destination_service_name: server
  destination_service_namespace: default
  source:
    uid: //compute.googleapis.com/projects/test-project/zones/us-east4-b/instances/productpage-vm
    location: us-east4-b
    owner_uid: //compute.googleapis.com/projects/test-project/zones/us-east4-b/instances/productpage-vm
    workload_name: productpage-v1
    workload_namespace: default
    canonical_service: productpage-v1
    canonical_revision: version-1
  destination:
    uid: //compute.googleapis.com/projects/test-project/zones/us-east4-b/instances/ratings-v1-vm
    location: us-east4-b
    owner_uid: //compute.googleapis.com/projects/23412341234/instanceGroupManagers/324234
    workload_name: ratings-v1
    workload_namespace: default
    canonical_service: ratings
    canonical_revision: version-1


2020/08/17 14:34:10 XDS server starting on 20005
2020/08/17 14:34:10 Stackdriver server listening on port 20006
2020/08/17 14:34:10 Pinging URL:  http://localhost:20007/health
2020/08/17 14:34:10 HTTP GET http://localhost:20007/health
2020/08/17 14:34:10 Server is up and running...
2020/08/17 14:34:10 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20002
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_outbound"
              vm_config:
                vm_id: "stackdriver_outbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:10 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20003
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_inbound"
              vm_config:
                vm_id: "stackdriver_inbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {"enableMeshEdgesReporting": "true", "meshEdgesReportingDuration": "1s"}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:10 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CLUSTER_ID,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-vm",
"NAMESPACE": "default",
"PLATFORM_METADATA": {
    "gcp_gce_instance_id": "2342123412341234",
    "gcp_gce_instance_created_by": "projects/23412341234/instanceGroupManagers/324234",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project",
    "gcp_project_number": "23413241234",
},
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20006",
"STACKDRIVER_ROOT_CA_FILE": "/root/proxy/testdata/certs/stackdriver.pem",
"STACKDRIVER_TOKEN_FILE": "/root/proxy/testdata/certs/access-token",
"STS_PORT": "20007",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1", }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20004

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20005
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20000
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20000
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:10 admin port 20004
2020/08/17 14:34:11 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-053254634.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:11 stopping XDS server
--- FAIL: TestStackdriverGCEInstances (0.65s)
    stackdriver_xds_test.go:469: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
2020/08/17 14:34:11 XDS server starting on 20285
2020/08/17 14:34:11 Stackdriver server listening on port 20286
2020/08/17 14:34:11 Pinging URL:  http://localhost:20287/health
2020/08/17 14:34:11 HTTP GET http://localhost:20287/health
2020/08/17 14:34:11 Server is up and running...
2020/08/17 14:34:11 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20282
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_outbound"
              vm_config:
                vm_id: "stackdriver_outbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:11 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20283
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_inbound"
              vm_config:
                vm_id: "stackdriver_inbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {"enableMeshEdgesReporting": "true", "meshEdgesReportingDuration": "1s"}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:11 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20286",
"STACKDRIVER_ROOT_CA_FILE": "/root/proxy/testdata/certs/stackdriver.pem",
"STACKDRIVER_TOKEN_FILE": "/root/proxy/testdata/certs/access-token",
"STS_PORT": "20287",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20284

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20285
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20280
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20280
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:11 admin port 20284
2020/08/17 14:34:11 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-688041537.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:11 stopping XDS server
--- FAIL: TestStackdriverParallel (0.40s)
    stackdriver_xds_test.go:518: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
labels:
  destination_name: ratings-v1-84975bc778-pxz2w
  destination_namespace: default
  destination_workload: ratings-v1
  destination_app: ratings
  destination_canonical_service: ratings
  destination_canonical_revision: version-1
  destination_version: v1
  mesh_uid: mesh
logName: projects/test-project/logs/server-accesslog-stackdriver
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

http_request:
  request_method: "GET"
  request_url: "http://127.0.0.1:20122/"
  server_ip: "127.0.0.1:20123"
  protocol: "http"
  status: 200
labels:
  destination_principal: ""
  destination_service_host: server.default.svc.cluster.local
  response_flag: "-"
  service_authentication_policy: NONE
  source_name: productpage-v1-84975bc778-pxz2w
  source_namespace: default
  source_principal: ""
  source_workload: productpage-v1
  source_app: productpage
  source_canonical_service: productpage-v1
  source_canonical_revision: version-1
  source_version: v1
severity: INFO
2020/08/17 14:34:11 XDS server starting on 20125
2020/08/17 14:34:11 Stackdriver server listening on port 20126
2020/08/17 14:34:11 Pinging URL:  http://localhost:20127/health
2020/08/17 14:34:11 HTTP GET http://localhost:20127/health
2020/08/17 14:34:11 Server is up and running...
2020/08/17 14:34:11 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20122
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_outbound"
              vm_config:
                vm_id: "stackdriver_outbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:11 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20123
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.access_log_policy" }
              configuration: "{ log_window_duration: \"15s\" }"
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_inbound"
              vm_config:
                vm_id: "stackdriver_inbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  
2020/08/17 14:34:11 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20126",
"STACKDRIVER_ROOT_CA_FILE": "/root/proxy/testdata/certs/stackdriver.pem",
"STACKDRIVER_TOKEN_FILE": "/root/proxy/testdata/certs/access-token",
"STS_PORT": "20127",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20124

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20125
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20120
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20120
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:11 admin port 20124
2020/08/17 14:34:12 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-107900076.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:12 stopping XDS server
labels:
  destination_name: ratings-v1-84975bc778-pxz2w
  destination_namespace: default
  destination_workload: ratings-v1
  destination_app: ratings
  destination_canonical_service: ratings
  destination_canonical_revision: version-1
  destination_version: v1
  mesh_uid: mesh
logName: projects/test-project/logs/server-accesslog-stackdriver
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

http_request:
  request_method: "GET"
  request_url: "http://127.0.0.1:20142/"
  server_ip: "127.0.0.1:20143"
  protocol: "http"
  status: 200
labels:
  destination_principal: ""
  destination_service_host: server.default.svc.cluster.local
  response_flag: "-"
  service_authentication_policy: NONE
  source_name: productpage-v1-84975bc778-pxz2w
  source_namespace: default
  source_principal: ""
  source_workload: productpage-v1
  source_app: productpage
  source_canonical_service: productpage-v1
  source_canonical_revision: version-1
  source_version: v1
severity: INFO
2020/08/17 14:34:12 XDS server starting on 20145
2020/08/17 14:34:12 Stackdriver server listening on port 20146
2020/08/17 14:34:12 Pinging URL:  http://localhost:20147/health
2020/08/17 14:34:12 HTTP GET http://localhost:20147/health
2020/08/17 14:34:12 Server is up and running...
2020/08/17 14:34:12 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20142
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_outbound"
              vm_config:
                vm_id: "stackdriver_outbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:12 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20143
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.access_log_policy" }
              configuration: "{ log_window_duration: \"1s\" }"
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_inbound"
              vm_config:
                vm_id: "stackdriver_inbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  
2020/08/17 14:34:12 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20146",
"STACKDRIVER_ROOT_CA_FILE": "/root/proxy/testdata/certs/stackdriver.pem",
"STACKDRIVER_TOKEN_FILE": "/root/proxy/testdata/certs/access-token",
"STS_PORT": "20147",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20144

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20145
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20140
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20140
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:12 admin port 20144
2020/08/17 14:34:12 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-574991899.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:12 stopping XDS server
labels:
  destination_name: ratings-v1-84975bc778-pxz2w
  destination_namespace: default
  destination_workload: ratings-v1
  destination_app: ratings
  destination_canonical_service: ratings
  destination_canonical_revision: version-1
  destination_version: v1
  mesh_uid: mesh
logName: projects/test-project/logs/server-accesslog-stackdriver
resource:
  labels:
    cluster_name: test-cluster
    container_name: server
    location: us-east4-b
    namespace_name: default
    pod_name: ratings-v1-84975bc778-pxz2w
    project_id: test-project
  type: k8s_container

http_request:
  request_method: "GET"
  request_url: "http://127.0.0.1:20162/"
  server_ip: "127.0.0.1:20163"
  protocol: "http"
  status: 500
labels:
  destination_principal: ""
  destination_service_host: server.default.svc.cluster.local
  response_flag: "-"
  service_authentication_policy: NONE
  source_name: productpage-v1-84975bc778-pxz2w
  source_namespace: default
  source_principal: ""
  source_workload: productpage-v1
  source_app: productpage
  source_canonical_service: productpage-v1
  source_canonical_revision: version-1
  source_version: v1
severity: INFO
2020/08/17 14:34:12 XDS server starting on 20165
2020/08/17 14:34:12 Stackdriver server listening on port 20166
2020/08/17 14:34:12 Pinging URL:  http://localhost:20167/health
2020/08/17 14:34:12 HTTP GET http://localhost:20167/health
2020/08/17 14:34:12 Server is up and running...
2020/08/17 14:34:12 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20162
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_outbound"
              vm_config:
                vm_id: "stackdriver_outbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:12 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20163
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.access_log_policy" }
              configuration: "{ log_window_duration: \"1s\" }"
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stackdriver_inbound"
              vm_config:
                vm_id: "stackdriver_inbound"
                runtime: "envoy.wasm.runtime.null"
                code:
                  local: { inline_string: "envoy.wasm.null.stackdriver" }
              configuration: >-
                {}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  
2020/08/17 14:34:12 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20166",
"STACKDRIVER_ROOT_CA_FILE": "/root/proxy/testdata/certs/stackdriver.pem",
"STACKDRIVER_TOKEN_FILE": "/root/proxy/testdata/certs/access-token",
"STS_PORT": "20167",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20164

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20165
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20160
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20160
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 500
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:12 admin port 20164
2020/08/17 14:34:12 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-561347774.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:12 stopping XDS server
--- FAIL: TestStackdriverAccessLog (1.29s)
    --- FAIL: TestStackdriverAccessLog/StackdriverAndAccessLogPlugin (0.62s)
        stackdriver_xds_test.go:590: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
    --- FAIL: TestStackdriverAccessLog/RequestGetsLoggedAgain (0.25s)
        stackdriver_xds_test.go:590: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
    --- FAIL: TestStackdriverAccessLog/AllErrorRequestsGetsLogged (0.42s)
        stackdriver_xds_test.go:590: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
FAIL
FAIL	istio.io/proxy/test/envoye2e/stackdriver_plugin	8.345s
?   	istio.io/proxy/test/envoye2e/stackdriver_plugin/cmd	[no test files]
2020/08/17 14:34:05 XDS server starting on 20305
2020/08/17 14:34:05 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20302
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_outbound"
              vm_config:
                vm_id: stats_outbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":"false","field_separator":";.;","max_peer_cache_size":20,"metrics":[{"dimensions":{"configurable_metric_a":"(request.host.startsWith('127.0.0.1') ? 'localhost:' : request.host) + string(upstream_peer_id)","configurable_metric_b":"request.protocol"}}]}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:05 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20303
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_inbound"
              vm_config:
                vm_id: stats_inbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":false,"field_separator":";.;","max_peer_cache_size":20}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:05 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20306",
"STACKDRIVER_ROOT_CA_FILE": "",
"STACKDRIVER_TOKEN_FILE": "",
"STS_PORT": "20307",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20304
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20305
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20300
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20300
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:05 admin port 20304
2020/08/17 14:34:05 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-748458734.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:05 stopping XDS server
2020/08/17 14:34:05 XDS server starting on 20325
2020/08/17 14:34:05 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20322
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_outbound"
              vm_config:
                vm_id: stats_outbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":"false","definitions":[{"name":"requests_total","type":"COUNTER","value":"10"},{"name":"custom","type":"COUNTER","value":"1"}],"field_separator":";.;","max_peer_cache_size":20,"metrics":[{"dimensions":{"reporter":"'proxy'"},"name":"custom"},{"tags_to_remove":["response_flags","source_principal"]},{"dimensions":{"configurable_metric_a":"'gateway'","destination_app":"cannot _ parse","destination_service_namespace":"'_' + upstream_peer.labels['app'].value","destination_version":"'_' + (has(node.metadata.LABELS.version) ? node.metadata.LABELS.version : 'unknown')","destination_workload":"cannot_evaluate","request_protocol":"request.protocol","source_app":"'_' + node.metadata['LABELS']['app']","source_version":"'_' + node.metadata['LABELS']['app']","source_workload":"'_' + node.metadata['WORKLOAD_NAME']","source_workload_namespace":"'_' + node.metadata['NAMESPACE']"},"name":"requests_total","tags_to_remove":["grpc_response_status"]},{"dimensions":{"configurable_metric_b":"'test'"},"name":"request_bytes","tags_to_remove":["reporter"]},{"dimensions":{"source_principal":"'malicious'"}}]}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:05 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20323
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_inbound"
              vm_config:
                vm_id: stats_inbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":false,"field_separator":";.;","max_peer_cache_size":20}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:05 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20326",
"STACKDRIVER_ROOT_CA_FILE": "",
"STACKDRIVER_TOKEN_FILE": "",
"STS_PORT": "20327",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20324
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20325
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20320
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20320
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:05 admin port 20324
2020/08/17 14:34:06 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-218001269.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:06 stopping XDS server
2020/08/17 14:34:08 XDS server starting on 20345
2020/08/17 14:34:08 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20342
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_outbound"
              vm_config:
                vm_id: stats_outbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":"false","field_separator":";.;","max_peer_cache_size":20,"metrics":[{"dimensions":{"configurable_metric_a":"(request.host.startsWith('127.0.0.1') ? 'localhost:' : request.host) + string(upstream_peer_id)","configurable_metric_b":"request.protocol"}}]}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: host_header
              timeout: 0s

2020/08/17 14:34:08 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20343
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_inbound"
              vm_config:
                vm_id: stats_inbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":false,"field_separator":";.;","max_peer_cache_size":20}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:08 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20346",
"STACKDRIVER_ROOT_CA_FILE": "",
"STACKDRIVER_TOKEN_FILE": "",
"STS_PORT": "20347",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20344
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20345
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20340
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20340
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:08 admin port 20344
2020/08/17 14:34:08 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-048283216.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:08 stopping XDS server
2020/08/17 14:34:08 XDS server starting on 20365
2020/08/17 14:34:08 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20362
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_outbound"
              vm_config:
                vm_id: stats_outbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":"false","disable_host_header_fallback":"true","field_separator":";.;","max_peer_cache_size":20,"metrics":[{"dimensions":{"configurable_metric_a":"(request.host.startsWith('127.0.0.1') ? 'localhost:' : request.host) + string(upstream_peer_id)","configurable_metric_b":"request.protocol"}}]}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: host_header
              timeout: 0s

2020/08/17 14:34:08 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20363
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_inbound"
              vm_config:
                vm_id: stats_inbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":false,"field_separator":";.;","max_peer_cache_size":20}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:08 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20366",
"STACKDRIVER_ROOT_CA_FILE": "",
"STACKDRIVER_TOKEN_FILE": "",
"STS_PORT": "20367",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20364
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20365
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20360
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20360
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:08 admin port 20364
2020/08/17 14:34:08 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-205973871.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:08 stopping XDS server
--- FAIL: TestStatsPayload (4.35s)
    --- FAIL: TestStatsPayload/Default/envoy.wasm.runtime.null (0.90s)
        stats_xds_test.go:289: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
    --- FAIL: TestStatsPayload/Customized/envoy.wasm.runtime.null (0.89s)
        stats_xds_test.go:289: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
    --- FAIL: TestStatsPayload/UseHostHeader/envoy.wasm.runtime.null (2.22s)
        stats_xds_test.go:289: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
    --- FAIL: TestStatsPayload/DisableHostHeader/envoy.wasm.runtime.null (0.33s)
        stats_xds_test.go:289: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
name: istio_requests_total
type: COUNTER
metric:
- counter:
    value: 1
  label:
  - name: reporter
    value: source
  - name: source_workload
    value: productpage-v1
  - name: source_canonical_service
    value: productpage-v1
  - name: source_canonical_revision
    value: version-1
  - name: source_workload_namespace
    value: default
  - name: source_principal
    value: unknown
  - name: source_app
    value: productpage
  - name: source_version
    value: v1
  - name: destination_workload
    value: ratings-v1
  - name: destination_workload_namespace
    value: default
  - name: destination_principal
    value: unknown
  - name: destination_app
    value: ratings
  - name: destination_version
    value: v1
  - name: destination_service
    value: server.default.svc.cluster.local
  - name: destination_canonical_service
    value: ratings
  - name: destination_canonical_revision
    value: version-1
  - name: destination_service_name
    value: server
  - name: destination_service_namespace
    value: default
  - name: request_protocol
    value: http
  - name: response_code
    value: "200"
  - name: grpc_response_status
    value: ""
  - name: response_flags
    value: "-"
  - name: connection_security_policy
    value: unknown
  - name: configurable_metric_a
    value: localhost:server
  - name: configurable_metric_b
    value: HTTP/1.1

name: istio_requests_total
type: COUNTER
metric:
- counter:
    value: 1
  label:
  - name: reporter
    value: destination
  - name: source_workload
    value: productpage-v1
  - name: source_canonical_service
    value: productpage-v1
  - name: source_canonical_revision
    value: version-1
  - name: source_workload_namespace
    value: default
  - name: source_principal
    value: unknown
  - name: source_app
    value: productpage
  - name: source_version
    value: v1
  - name: destination_workload
    value: ratings-v1
  - name: destination_workload_namespace
    value: default
  - name: destination_principal
    value: unknown
  - name: destination_app
    value: ratings
  - name: destination_version
    value: v1
  - name: destination_service
    value: server.default.svc.cluster.local
  - name: destination_canonical_service
    value: ratings
  - name: destination_canonical_revision
    value: version-1
  - name: destination_service_name
    value: server
  - name: destination_service_namespace
    value: default
  - name: request_protocol
    value: http
  - name: response_code
    value: "200"
  - name: grpc_response_status
    value: ""
  - name: response_flags
    value: "-"
  - name: connection_security_policy
    value: none

2020/08/17 14:34:08 XDS server starting on 20005
2020/08/17 14:34:08 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20002
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_outbound"
              vm_config:
                vm_id: stats_outbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":"false","field_separator":";.;","max_peer_cache_size":20,"metrics":[{"dimensions":{"configurable_metric_a":"(request.host.startsWith('127.0.0.1') ? 'localhost:' : request.host) + string(upstream_peer_id)","configurable_metric_b":"request.protocol"}}]}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:08 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20003
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_inbound"
              vm_config:
                vm_id: stats_inbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":false,"field_separator":";.;","max_peer_cache_size":20}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:08 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20006",
"STACKDRIVER_ROOT_CA_FILE": "",
"STACKDRIVER_TOKEN_FILE": "",
"STS_PORT": "20007",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20004
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20005
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20000
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20000
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:08 admin port 20004
2020/08/17 14:34:08 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-281161218.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:08 stopping XDS server
name: istio_requests_total
type: COUNTER
metric:
- counter:
    value: 1
  label:
  - name: reporter
    value: source
  - name: source_workload
    value: productpage-v1
  - name: source_canonical_service
    value: productpage-v1
  - name: source_canonical_revision
    value: version-1
  - name: source_workload_namespace
    value: default
  - name: source_principal
    value: unknown
  - name: source_app
    value: productpage
  - name: source_version
    value: v1
  - name: destination_workload
    value: ratings-v1
  - name: destination_workload_namespace
    value: default
  - name: destination_principal
    value: unknown
  - name: destination_app
    value: ratings
  - name: destination_version
    value: v1
  - name: destination_service
    value: server.default.svc.cluster.local
  - name: destination_canonical_service
    value: ratings
  - name: destination_canonical_revision
    value: version-1
  - name: destination_service_name
    value: server
  - name: destination_service_namespace
    value: default
  - name: request_protocol
    value: http
  - name: response_code
    value: "200"
  - name: grpc_response_status
    value: ""
  - name: response_flags
    value: "-"
  - name: connection_security_policy
    value: unknown
  - name: configurable_metric_a
    value: localhost:server
  - name: configurable_metric_b
    value: HTTP/1.1

name: istio_requests_total
type: COUNTER
metric:
- counter:
    value: 1
  label:
  - name: reporter
    value: destination
  - name: source_workload
    value: productpage-v1
  - name: source_canonical_service
    value: productpage-v1
  - name: source_canonical_revision
    value: version-1
  - name: source_workload_namespace
    value: default
  - name: source_principal
    value: unknown
  - name: source_app
    value: productpage
  - name: source_version
    value: v1
  - name: destination_workload
    value: ratings-v1
  - name: destination_workload_namespace
    value: default
  - name: destination_principal
    value: unknown
  - name: destination_app
    value: ratings
  - name: destination_version
    value: v1
  - name: destination_service
    value: server.default.svc.cluster.local
  - name: destination_canonical_service
    value: ratings
  - name: destination_canonical_revision
    value: version-1
  - name: destination_service_name
    value: server
  - name: destination_service_namespace
    value: default
  - name: request_protocol
    value: http
  - name: response_code
    value: "200"
  - name: grpc_response_status
    value: ""
  - name: response_flags
    value: "-"
  - name: connection_security_policy
    value: none

2020/08/17 14:34:09 XDS server starting on 20005
2020/08/17 14:34:09 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20002
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_outbound"
              vm_config:
                vm_id: stats_outbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":"false","definitions":[{"name":"requests_total","type":"COUNTER","value":"10"},{"name":"custom","type":"COUNTER","value":"1"}],"field_separator":";.;","max_peer_cache_size":20,"metrics":[{"dimensions":{"reporter":"'proxy'"},"name":"custom"},{"tags_to_remove":["response_flags","source_principal"]},{"dimensions":{"configurable_metric_a":"'gateway'","destination_app":"cannot _ parse","destination_service_namespace":"'_' + upstream_peer.labels['app'].value","destination_version":"'_' + (has(node.metadata.LABELS.version) ? node.metadata.LABELS.version : 'unknown')","destination_workload":"cannot_evaluate","request_protocol":"request.protocol","source_app":"'_' + node.metadata['LABELS']['app']","source_version":"'_' + node.metadata['LABELS']['app']","source_workload":"'_' + node.metadata['WORKLOAD_NAME']","source_workload_namespace":"'_' + node.metadata['NAMESPACE']"},"name":"requests_total","tags_to_remove":["grpc_response_status"]},{"dimensions":{"configurable_metric_b":"'test'"},"name":"request_bytes","tags_to_remove":["reporter"]},{"dimensions":{"source_principal":"'malicious'"}}]}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:09 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20003
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_inbound"
              vm_config:
                vm_id: stats_inbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":false,"field_separator":";.;","max_peer_cache_size":20}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:09 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20006",
"STACKDRIVER_ROOT_CA_FILE": "",
"STACKDRIVER_TOKEN_FILE": "",
"STS_PORT": "20007",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20004
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20005
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20000
  
  listeners:
  - name: staticreply
    address:
      socket_address:
        address: 127.0.0.1
        port_value: 20000
    filter_chains:
    - filters:
      - name: http
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: staticreply
          codec_type: AUTO
          route_config:
            name: staticreply
            virtual_hosts:
            - name: staticreply
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                direct_response:
                  status: 200
                  body:
                    inline_string: "hello, world!"
          http_filters:
          - name: envoy.filters.http.router

2020/08/17 14:34:09 admin port 20004
2020/08/17 14:34:09 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-987421561.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:09 stopping XDS server
--- FAIL: TestStatsParallel (0.73s)
    --- FAIL: TestStatsParallel/Default (0.36s)
        stats_xds_test.go:355: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
    --- FAIL: TestStatsParallel/Customized (0.37s)
        stats_xds_test.go:355: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
2020/08/17 14:34:09 XDS server starting on 20485
2020/08/17 14:34:09 update config for "client" with version "0"

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20482
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: client0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_outbound"
              vm_config:
                vm_id: stats_outbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":"false","field_separator":";.;","max_peer_cache_size":20,"metrics":[{"dimensions":{"configurable_metric_a":"(request.host.startsWith('127.0.0.1') ? 'localhost:' : request.host) + string(upstream_peer_id)","configurable_metric_b":"request.protocol"}}]}
      - name: envoy.filters.http.router
      route_config:
        name: client
        virtual_hosts:
        - name: client
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: outbound|9080|http|server.default.svc.cluster.local
              timeout: 0s

2020/08/17 14:34:09 update config for "server" with version "0"

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20483
filter_chains:
- filters:
  - name: http
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      codec_type: AUTO
      stat_prefix: server0
      http_filters:
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.metadata_exchange" }
              configuration: |
                { "max_peer_cache_size": 20 }
      - name: envoy.filters.http.wasm
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              root_id: "stats_inbound"
              vm_config:
                vm_id: stats_inbound0
                runtime: envoy.wasm.runtime.null
                code:
                  local: { inline_string: "envoy.wasm.stats" }
              configuration: |
                {"debug":false,"field_separator":";.;","max_peer_cache_size":20}
      - name: envoy.filters.http.router
      route_config:
        name: server
        virtual_hosts:
        - name: server
          domains: ["*"]
          routes:
          - match: { prefix: / }
            route:
              cluster: inbound|9080|http|server.default.svc.cluster.local
              timeout: 0s
  

2020/08/17 14:34:09 envoy bootstrap:
node:
  id: server
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "server",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "ratings",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "ratings",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "ratings-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/ratings-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "ratings-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-ratings",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20486",
"STACKDRIVER_ROOT_CA_FILE": "",
"STACKDRIVER_TOKEN_FILE": "",
"STS_PORT": "20487",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"WORKLOAD_NAME": "ratings-v1",
"app": "ratings",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container ratings",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20484
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20485
    http2_protocol_options: {}
    name: xds_cluster
  - name: inbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    http2_protocol_options: {}
    load_assignment:
      cluster_name: inbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20480
  

2020/08/17 14:34:09 admin port 20484
2020/08/17 14:34:09 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-687796356.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:09 stopping XDS server
--- FAIL: TestStatsGrpc (0.24s)
    stats_xds_test.go:402: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
FAIL
FAIL	istio.io/proxy/test/envoye2e/stats_plugin	5.326s
2020/08/17 14:34:05 XDS server starting on 20505
2020/08/17 14:34:05 update config for "client" with version "0"
name: outbound|9080|tcp|server.default.svc.cluster.local
connect_timeout: 1s
type: STATIC
load_assignment:
  cluster_name: outbound|9080|tcp|server.default.svc.cluster.local
  endpoints:
  - lb_endpoints:
    - endpoint:
        address:
          socket_address:
            address: 127.0.0.1
            port_value: 20503
transport_socket:
  name: tls
  typed_config:
    "@type": type.googleapis.com/udpa.type.v1.TypedStruct
    type_url: envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
    value:
      common_tls_context:
        alpn_protocols:
        - mx-protocol
        tls_certificates:
        - certificate_chain: { filename: "testdata/certs/client.cert" }
          private_key: { filename: "testdata/certs/client-key.cert" }
        validation_context:
          trusted_ca: { filename: "testdata/certs/root.cert" }
filters:

- name: istio.metadata_exchange
  typed_config: 
    "@type": type.googleapis.com/udpa.type.v1.TypedStruct
    type_url: envoy.tcp.metadataexchange.config.MetadataExchange
    value:
      protocol: mx-protocol

name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20502
listener_filters:
- name: "envoy.filters.listener.tls_inspector"
- name: "envoy.filters.listener.http_inspector"
filter_chains:
- filters:
  
  - name: istio.stats
    typed_config:
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.extensions.filters.network.wasm.v3.Wasm
      value:
        config:
          root_id: "stats_outbound"
          vm_config:
            runtime: envoy.wasm.runtime.null
            code:
              local: { inline_string: "envoy.wasm.stats" }
          configuration: |
            { "debug": "false", "field_separator": ";.;", "tcp_reporting_duration": "1s" }
  - name: tcp_proxy
    typed_config:
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
      value:
        stat_prefix: outbound_tcp
        cluster: outbound|9080|tcp|server.default.svc.cluster.local
2020/08/17 14:34:05 update config for "server" with version "0"
name: inbound|9080|tcp|server.default.svc.cluster.local
connect_timeout: 1s
type: STATIC
load_assignment:
  cluster_name: inbound|9080|tcp|server.default.svc.cluster.local
  endpoints:
  - lb_endpoints:
    - endpoint:
        address:
          socket_address:
            address: 127.0.0.1
            port_value: 20500

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20503
listener_filters:
- name: "envoy.filters.listener.tls_inspector"
- name: "envoy.filters.listener.http_inspector"
filter_chains:
- filters:
  
  - name: istio.metadata_exchange
    typed_config: 
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.tcp.metadataexchange.config.MetadataExchange
      value:
        protocol: mx-protocol
  - name: istio.stats
    typed_config:
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.extensions.filters.network.wasm.v3.Wasm
      value:
        config:
          root_id: "stats_inbound"
          vm_config:
            runtime: envoy.wasm.runtime.null
            code:
              local: { inline_string: "envoy.wasm.stats" }
          configuration: |
            { "debug": "false", "field_separator": ";.;", "tcp_reporting_duration": "1s" }
  - name: tcp_proxy
    typed_config:
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
      value:
        stat_prefix: inbound_tcp
        cluster: inbound|9080|tcp|server.default.svc.cluster.local
  transport_socket:
    name: tls
    typed_config:
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
      value:
        common_tls_context:
          alpn_protocols:
          - mx-protocol
          tls_certificates:
          - certificate_chain: { filename: "testdata/certs/server.cert" }
            private_key: { filename: "testdata/certs/server-key.cert" }
          validation_context:
            trusted_ca: { filename: "testdata/certs/root.cert" }
        require_client_certificate: true
2020/08/17 14:34:05 envoy bootstrap:
node:
  id: client
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "test,bonzai",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "productpage",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "productpage-v1",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "productpage-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "productpage-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-productpage",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20506",
"STACKDRIVER_ROOT_CA_FILE": "",
"STACKDRIVER_TOKEN_FILE": "",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"STS_PORT": "20507",
"WORKLOAD_NAME": "productpage-v1",
"app": "productpage",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container productpage",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20501
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20505
    http2_protocol_options: {}
    name: xds_cluster
  - name: outbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    http2_protocol_options: {}
    load_assignment:
      cluster_name: outbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20503
    
  

2020/08/17 14:34:05 admin port 20501
2020/08/17 14:34:05 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-280464721.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:05 stopping XDS server
--- FAIL: TestTCPMetadataExchange (1.51s)
    tcp_metadata_exchange_test.go:155: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
2020/08/17 14:34:05 XDS server starting on 20525
2020/08/17 14:34:05 update config for "client" with version "0"
name: outbound|9080|tcp|server.default.svc.cluster.local
connect_timeout: 1s
type: STATIC
load_assignment:
  cluster_name: outbound|9080|tcp|server.default.svc.cluster.local
  endpoints:
  - lb_endpoints:
    - endpoint:
        address:
          socket_address:
            address: 127.0.0.1
            port_value: 20523
transport_socket:
  name: tls
  typed_config:
    "@type": type.googleapis.com/udpa.type.v1.TypedStruct
    type_url: envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
    value:
      common_tls_context:
        alpn_protocols:
        - some-protocol
        tls_certificates:
        - certificate_chain: { filename: "testdata/certs/client.cert" }
          private_key: { filename: "testdata/certs/client-key.cert" }
        validation_context:
          trusted_ca: { filename: "testdata/certs/root.cert" }
filters:


name: client
traffic_direction: OUTBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20522
listener_filters:
- name: "envoy.filters.listener.tls_inspector"
- name: "envoy.filters.listener.http_inspector"
filter_chains:
- filters:
  - name: tcp_proxy
    typed_config:
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
      value:
        stat_prefix: outbound_tcp
        cluster: outbound|9080|tcp|server.default.svc.cluster.local
2020/08/17 14:34:05 update config for "server" with version "0"
name: inbound|9080|tcp|server.default.svc.cluster.local
connect_timeout: 1s
type: STATIC
load_assignment:
  cluster_name: inbound|9080|tcp|server.default.svc.cluster.local
  endpoints:
  - lb_endpoints:
    - endpoint:
        address:
          socket_address:
            address: 127.0.0.1
            port_value: 20520

name: server
traffic_direction: INBOUND
address:
  socket_address:
    address: 127.0.0.1
    port_value: 20523
listener_filters:
- name: "envoy.filters.listener.tls_inspector"
- name: "envoy.filters.listener.http_inspector"
filter_chains:
- filters:
  
  - name: istio.metadata_exchange
    typed_config: 
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.tcp.metadataexchange.config.MetadataExchange
      value:
        protocol: mx-protocol
  - name: istio.stats
    typed_config:
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.extensions.filters.network.wasm.v3.Wasm
      value:
        config:
          root_id: "stats_inbound"
          vm_config:
            runtime: envoy.wasm.runtime.null
            code:
              local: { inline_string: "envoy.wasm.stats" }
          configuration: |
            { "debug": "false", "field_separator": ";.;", "tcp_reporting_duration": "1s" }
  - name: tcp_proxy
    typed_config:
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
      value:
        stat_prefix: inbound_tcp
        cluster: inbound|9080|tcp|server.default.svc.cluster.local
  transport_socket:
    name: tls
    typed_config:
      "@type": type.googleapis.com/udpa.type.v1.TypedStruct
      type_url: envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
      value:
        common_tls_context:
          alpn_protocols:
          - some-protocol
          tls_certificates:
          - certificate_chain: { filename: "testdata/certs/server.cert" }
            private_key: { filename: "testdata/certs/server-key.cert" }
          validation_context:
            trusted_ca: { filename: "testdata/certs/root.cert" }
        require_client_certificate: true
2020/08/17 14:34:05 envoy bootstrap:
node:
  id: client
  cluster: test-cluster
  metadata: { "APP_CONTAINERS": "test,bonzai",
"CONFIG_NAMESPACE": "default",
"EXCHANGE_KEYS": "NAME,NAMESPACE,INSTANCE_IPS,LABELS,OWNER,PLATFORM_METADATA,WORKLOAD_NAME,CANONICAL_TELEMETRY_SERVICE,MESH_ID,SERVICE_ACCOUNT",
"INCLUDE_INBOUND_PORTS": "9080",
"INSTANCE_IPS": "10.52.0.34,fe80::a075:11ff:fe5e:f1cd",
"INTERCEPTION_MODE": "REDIRECT",
"ISTIO_PROXY_SHA": "istio-proxy:47e4559b8e4f0d516c0d17b233d127a3deb3d7ce",
"ISTIO_VERSION": "1.5-dev",
"LABELS": {
    "app": "productpage",
    "pod-template-hash": "84975bc778",
    "version": "v1",
    "service.istio.io/canonical-name": "productpage-v1",
    "service.istio.io/canonical-revision": "version-1"
},
"MESH_ID": "mesh",
"NAME": "productpage-v1-84975bc778-pxz2w",
"NAMESPACE": "default",
"OWNER": "kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1",
"PLATFORM_METADATA": {
    "gcp_gke_cluster_name": "test-cluster",
    "gcp_location": "us-east4-b",
    "gcp_project": "test-project"
},
"POD_NAME": "productpage-v1-84975bc778-pxz2w",
"SERVICE_ACCOUNT": "bookinfo-productpage",
"SECURE_STACKDRIVER_ENDPOINT": "localhost:20526",
"STACKDRIVER_ROOT_CA_FILE": "",
"STACKDRIVER_TOKEN_FILE": "",
"STACKDRIVER_MONITORING_EXPORT_INTERVAL_SECS": "20",
"STACKDRIVER_LOGGING_EXPORT_INTERVAL_SECS": "20",
"STS_PORT": "20527",
"WORKLOAD_NAME": "productpage-v1",
"app": "productpage",
"istio": "sidecar",
"kubernetes.io/limit-ranger": "LimitRanger plugin set: cpu request for container productpage",
"pod-template-hash": "84975bc778",
"version": "v1"
 }
admin:
  access_log_path: /dev/null
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 20521
stats_config:
  use_all_default_tags: true
  stats_tags:
  - tag_name: "reporter"
    regex: "(reporter=\\.=(.*?);\\.;)"
  - tag_name: "source_namespace"
    regex: "(source_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_workload"
    regex: "(source_workload=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_service"
    regex: "(source_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "source_canonical_revision"
    regex: "(source_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "source_workload_namespace"
    regex: "(source_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "source_principal"
    regex: "(source_principal=\\.=(.*?);\\.;)"
  - tag_name: "source_app"
    regex: "(source_app=\\.=(.*?);\\.;)"
  - tag_name: "source_version"
    regex: "(source_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_namespace"
    regex: "(destination_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload"
    regex: "(destination_workload=\\.=(.*?);\\.;)"
  - tag_name: "destination_workload_namespace"
    regex: "(destination_workload_namespace=\\.=(.*?);\\.;)"
  - tag_name: "destination_principal"
    regex: "(destination_principal=\\.=(.*?);\\.;)"
  - tag_name: "destination_app"
    regex: "(destination_app=\\.=(.*?);\\.;)"
  - tag_name: "destination_version"
    regex: "(destination_version=\\.=(.*?);\\.;)"
  - tag_name: "destination_service"
    regex: "(destination_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_service"
    regex: "(destination_canonical_service=\\.=(.*?);\\.;)"
  - tag_name: "destination_canonical_revision"
    regex: "(destination_canonical_revision=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_name"
    regex: "(destination_service_name=\\.=(.*?);\\.;)"
  - tag_name: "destination_service_namespace"
    regex: "(destination_service_namespace=\\.=(.*?);\\.;)"
  - tag_name: "request_protocol"
    regex: "(request_protocol=\\.=(.*?);\\.;)"
  - tag_name: "response_code"
    regex: "(response_code=\\.=(.*?);\\.;)|_rq(_(\\.d{3}))$"
  - tag_name: "grpc_response_status"
    regex: "(grpc_response_status=\\.=(.*?);\\.;)"
  - tag_name: "response_flags"
    regex: "(response_flags=\\.=(.*?);\\.;)"
  - tag_name: "connection_security_policy"
    regex: "(connection_security_policy=\\.=(.*?);\\.;)"
# Extra regexes used for configurable metrics
  - tag_name: "configurable_metric_a"
    regex: "(configurable_metric_a=\\.=(.*?);\\.;)"
  - tag_name: "configurable_metric_b"
    regex: "(configurable_metric_b=\\.=(.*?);\\.;)"
# Internal monitoring
  - tag_name: "cache"
    regex: "(cache\\.(.*?)\\.)"
  - tag_name: "component"
    regex: "(component\\.(.*?)\\.)"
  - tag_name: "tag"
    regex: "(tag\\.(.*?);\\.)"
  - tag_name: "wasm_filter"
    regex: "(wasm_filter\\.(.*?)\\.)"

dynamic_resources:
  ads_config:
    api_type: GRPC
    transport_api_version: V3
    grpc_services:
    - envoy_grpc:
        cluster_name: xds_cluster
  cds_config:
    ads: {}
    resource_api_version: V3
  lds_config:
    ads: {}
    resource_api_version: V3
static_resources:
  clusters:
  - connect_timeout: 1s
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20525
    http2_protocol_options: {}
    name: xds_cluster
  - name: outbound|9080|http|server.default.svc.cluster.local
    connect_timeout: 1s
    type: STATIC
    http2_protocol_options: {}
    load_assignment:
      cluster_name: outbound|9080|http|server.default.svc.cluster.local
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 20523
    
  

2020/08/17 14:34:05 admin port 20521
2020/08/17 14:34:05 envoy cmd [/root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy -c /tmp/envoy-bootstrap-291922556.yaml -l info --concurrency 1 --disable-hot-restart --drain-time-s 4]
2020/08/17 14:34:05 stopping XDS server
--- FAIL: TestTCPMetadataExchangeNoAlpn (0.24s)
    tcp_metadata_exchange_test.go:200: fork/exec /root/.cache/bazel/_bazel_root/29eb40fb37a6c6016365b5a1e38b7d11/execroot/io_istio_proxy/bazel-out/k8-fastbuild/bin/src/envoy/envoy: no such file or directory
FAIL
FAIL	istio.io/proxy/test/envoye2e/tcp_metadata_exchange	1.765s
FAIL
Makefile.core.mk:102: recipe for target 'test' failed
make: *** [test] Error 1
